{% extends 'base.html' %}
{% block head %}
<script type="text/javascript" src="/static/qrcode.min.js"></script>
{% endblock %}
{% block content %}
{% load app_filters %}
{% load feed_filters %}
  <h2>{{ 'Broadcaster for Channel:'|etrans }} {{ request.user.profile.name }}</h2>
  <video style="width: 100%;" id="localVideo" autoplay muted playsinline></video>
    <button id="fullscreenToggle" class="btn btn-sm btn-outline-secondary">{{ 'Toggle Fullscreen'|etrans }}</button>
  <h3>{{ 'Chat'|etrans }}</h3>
  <div id="chatbox" style="overflow-y: scroll; height: 250px;"></div>
  <div class="input-group mb-3">
    <input id="chatinput" type="text" class="form-control" placeholder="{{ 'Type a message here'|etrans }}" aria-label="{{ 'Message'|etrans }}">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="sendChat();">{{ 'Send'|etrans }}</button>
    </div>
  </div>
{% include 'social.html' %}
{% endblock %}
{% block javascript %}
{% load app_filters %}
const video = document.getElementById('remoteVideo');
const fullscreenButton = document.getElementById('fullscreenToggle');
fullscreenButton.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    // Enter fullscreen mode
    if (video.requestFullscreen) {
      video.requestFullscreen();
    } else if (video.mozRequestFullScreen) { // Firefox
      video.mozRequestFullScreen();
    } else if (video.webkitRequestFullscreen) { // Chrome, Safari and Opera
      video.webkitRequestFullscreen();
    } else if (video.msRequestFullscreen) { // IE/Edge
      video.msRequestFullscreen();
    }
  } else {
    // Exit fullscreen mode
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.mozCancelFullScreen) { // Firefox
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { // IE/Edge
      document.msExitFullscreen();
    }
  }
});
var signalingSocket;
var signalingSocketReconnectTimeout;
function openSignalingSocket() {
    signalingSocket = new WebSocket("wss://" + window.location.host + "/ws/signaling/{{ request.user.profile.name }}/");
    signalingSocket.onerror = (event) => {
        if(signalingSocketReconnectTimeout) clearTimeout(signalingSocketReconnectTimeout);
        signalingSocketReconnectTimeout = setTimeout(function() {
            openSignalingSocket();
        }, {{ reload_time }});
    };
    signalingSocket.onclose = (event) => {
        if(signalingSocketReconnectTimeout) clearTimeout(signalingSocketReconnectTimeout);
        signalingSocketReconnectTimeout = setTimeout(function() {
            openSignalingSocket();
        }, {{ reload_time }});        
    };
    signalingSocket.onmessage = async (event) => {
        let data = JSON.parse(event.data);
        if (data.type === "answer") {
            let pc = peers[data.from];
            if (pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
        else if (data.type === "candidate") {
            let pc = peers[data.from];
            if (pc) await pc.addIceCandidate(data.candidate);
        }
        else if (data.type === "new_viewer") {
            // Call handleViewer with the viewer's channel name
            handleViewer(data.id);
        }
    };
}
openSignalingSocket();

const stunConfig = { iceServers: [{urls: "stun:lotteh.com:3478"}] };
let peers = {};
let localStream;

async function startBroadcast() {
    localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
    document.getElementById('localVideo').srcObject = localStream;
}
startBroadcast();

// When a viewer connects, create a peer connection and send offer
function handleViewer(id) {
    let pc = new RTCPeerConnection(stunConfig);
    peers[id] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.onicecandidate = e => {
        if (e.candidate) {
            signalingSocket.send(JSON.stringify({type:"candidate", candidate:e.candidate, to:id}));
        }
    };
    pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        signalingSocket.send(JSON.stringify({type:"offer", offer, to:id}));
    });
}
var chatSocket;
var chatSocketReconnectTimeout;
function openChatSocket() {
    chatSocket = new WebSocket(
        "wss://" + window.location.host + "/ws/chat/{{ request.user.profile.name }}/"
    );
    chatSocket.onerror = function() {
        if(chatSocketReconnectTimeout) clearTimeout(chatSocketReconnectTimeout);
        chatSocketReconnectTimeout = setTimeout(openChatSocket, {{ reload_time }});
    };
    chatSocket.onclose = function() {
        if(chatSocketReconnectTimeout) clearTimeout(chatSocketReconnectTimeout);
        chatSocketReconnectTimeout = setTimeout(openChatSocket, {{ reload_time }});
    };
    chatSocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        let chatbox = document.getElementById('chatbox');
        chatbox.innerHTML += `<div><b>${data.username}:</b> ${data.message}</div>`;
    };
}
openChatSocket();
    function sendChat() {
        let input = document.getElementById('chatinput');
        chatSocket.send(JSON.stringify({
            message: input.value,
            username: "@{{ request.user.profile.name }} (Streamer)"
        }));
        input.value = "";
    }
const inputField = document.getElementById('chatinput');
inputField.addEventListener('keydown', function(event) {
    if (event.keyCode === 13) { // 13 is the keyCode for the Enter key
        event.preventDefault(); // Prevent default Enter key behavior
        sendChat();
    }
});
/*remoteVideo.addEventListener("pause", (event) => {event.target.play();});
localVideo.addEventListener("pause", (event) => {event.target.play();});*/
{% endblock %}
