{% extends 'base.html' %}
{% block head %}
<script type="text/javascript" src="/static/qrcode.min.js"></script>
{% endblock %}
{% block content %}
{% load app_filters %}
{% load feed_filters %}
    <h2>{{ 'Viewing'|etrans }} {{ vendor.profile.name }}'s {{ 'Broadcast'|etrans }}</h2>
    <video style="width: 100%;" id="remoteVideo" autoplay playsinline></video>
    <h3>{{ 'Chat'|etrans }}</h3>
    <div id="chatbox"></div>
    <div class="input-group mb-3">
    <input id="chatinput" type="text" class="form-control" placeholder="{{ 'Type a message here'|etrans }}" aria-label="{{ 'Message'|etrans }}">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="sendChat();">{{ 'Send'|etrans }}</button>
    </div>
    </div>
{% include 'social.html' %}
{% endblock %}
{% block javascript %}
{% load app_filters %}
const signalingSocket = new WebSocket("wss://" + window.location.host + "/ws/signaling/{{ vendor.profile.name }}/");
const stunConfig = { iceServers: [{urls: "stun:lotteh.com:3478"}] };
let pc;
let broadcasterId = null;
signalingSocket.onmessage = async (event) => {
    let data = JSON.parse(event.data);
    if (data.type === "offer") {
        broadcasterId = data.from;
        pc = new RTCPeerConnection(stunConfig);
        pc.ontrack = e => {
            document.getElementById("remoteVideo").srcObject = e.streams[0];
        };
        pc.onicecandidate = e => {
            if (e.candidate) {
                signalingSocket.send(JSON.stringify({type:"candidate", candidate:e.candidate, to:broadcasterId}));
            }
        };
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        signalingSocket.send(JSON.stringify({type:"answer", answer, to:broadcasterId}));
    }
    else if (data.type === "candidate") {
        if (pc) await pc.addIceCandidate(data.candidate);
    }
};
    const chatSocket = new WebSocket(
        "wss://" + window.location.host + "/ws/chat/{{ vendor.profile.name }}/"
    );
    chatSocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        let chatbox = document.getElementById('chatbox');
        chatbox.innerHTML += `<div><b>${data.username}:</b> ${data.message}</div>`;
    };
    function sendChat() {
        let input = document.getElementById('chatinput');
        chatSocket.send(JSON.stringify({
            message: input.value,
            username: "{% if request.user.is_authenticated %}{{ request.user.profile.name }}{% else %}Guest{% endif %}"
        }));
        input.value = "";
    }
const inputField = document.getElementById('chatinput');
inputField.addEventListener('keydown', function(event) {     
    if (event.keyCode === 13) { // 13 is the keyCode for the Enter key
        event.preventDefault(); // Prevent default Enter key behavior
        sendChat();
    }
});
{% endblock %}
